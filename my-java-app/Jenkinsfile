pipeline {
    agent any

    tools {
        jdk 'jdk17'
        maven 'maven-3.9'
    }

    environment {
        PROJECT_KEY = "my-java-app"

        AWS_REGION = "ap-south-2"
        ECR_REPO   = "692614315837.dkr.ecr.ap-south-2.amazonaws.com/myrepo"

        NEXUS_URL  = "http://172.31.4.228:32081"
        IMAGE_TAG  = "${BUILD_NUMBER}"
    }

    stages {

        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Sonar Analysis') {
            steps {
                dir('my-java-app') {
                    withSonarQubeEnv('SonarQube-Server') {
                        withCredentials([
                            string(credentialsId: 'jenkins-token', variable: 'SONAR_TOKEN')
                        ]) {
                            sh '''
                            mvn clean verify sonar:sonar \
                              -Dsonar.projectKey=${PROJECT_KEY} \
                              -Dsonar.projectName=${PROJECT_KEY} \
                              -Dsonar.token=$SONAR_TOKEN
                            '''
                        }
                    }
                }
            }
        }

        stage('Build & Deploy to Nexus') {
            steps {
